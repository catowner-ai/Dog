<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯¶å¯å¤¢å¤§äº¨å‰å¾Œç«¯é€£ç·šç‰ˆ</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // è¨­å®š Tailwind é¡è‰²èˆ‡å­—é«”
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans TC', 'sans-serif'],
                    },
                    colors: {
                        'poke-blue': '#3B4CCA',
                        'poke-red': '#CC0000',
                        'poke-yellow': '#FFDE00',
                    }
                }
            }
        }
    </script>
    <style>
        .card {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s;
        }
        .card:hover {
            transform: translateY(-2px);
        }
        .status-success {
            background-color: #d1fae5; /* green-100 */
            color: #065f46; /* green-800 */
            border-left: 4px solid #10b981; /* green-500 */
        }
        .status-error {
            background-color: #fee2e2; /* red-100 */
            color: #991b1b; /* red-800 */
            border-left: 4px solid #ef4444; /* red-500 */
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-8 font-sans">

    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-8 p-4 bg-poke-red text-white rounded-lg shadow-xl">
            <h1 class="text-4xl font-extrabold tracking-tight">å¯¶å¯å¤¢å¤§äº¨ ğŸ“ˆ</h1>
            <p class="text-lg mt-1 font-medium">ä½¿ç”¨ Python (å¾Œç«¯) é€²è¡Œæ¨¡æ“¬ï¼Œä½¿ç”¨ Web (å‰ç«¯) é€²è¡Œäº¤æ˜“</p>
            <div id="status-message-container" class="mt-3 p-2 rounded-md font-bold text-sm">
                <span id="status-message" class="block">è«‹å…ˆé‹è¡Œæ‚¨çš„ Python (app.py) ä¼ºæœå™¨ï¼</span>
            </div>
        </header>

        <!-- ç‹€æ…‹èˆ‡æ§åˆ¶é¢æ¿ -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="card bg-white p-6 rounded-xl border-l-4 border-poke-blue col-span-1">
                <h2 class="text-2xl font-semibold text-gray-700">è³‡é‡‘ (Cash)</h2>
                <p id="cash-display" class="text-4xl font-bold text-green-600 mt-2">$0.00</p>
            </div>
            
            <div class="card bg-white p-6 rounded-xl border-l-4 border-gray-400 col-span-1">
                <h2 class="text-2xl font-semibold text-gray-700">å›åˆ (Turn)</h2>
                <p id="turn-display" class="text-4xl font-bold text-gray-600 mt-2">0</p>
            </div>

            <button id="simulate-button" class="col-span-1 bg-poke-blue text-white font-bold py-4 px-6 rounded-xl shadow-lg hover:bg-poke-blue/90 transition duration-150 transform hover:scale-105 disabled:opacity-50" disabled>
                <span class="text-xl">é‹è¡Œä¸‹ä¸€å›åˆå¸‚å ´æ¨¡æ“¬</span>
            </button>
        </div>

        <!-- å¸‚å ´äº¤æ˜“å€å¡Š -->
        <div id="market-area" class="bg-white p-6 rounded-xl shadow-xl">
            <h2 class="text-3xl font-bold text-gray-800 mb-4 border-b pb-2">ä»Šæ—¥å¸‚å ´åƒ¹æ ¼èˆ‡äº¤æ˜“</h2>
            <div id="market-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <p class="text-gray-500 col-span-2">ç­‰å¾…å¾Œç«¯é€£ç·š...</p>
            </div>
        </div>

        <!-- åº«å­˜å€å¡Š -->
        <div class="mt-8 bg-white p-6 rounded-xl shadow-xl">
            <h2 class="text-3xl font-bold text-gray-800 mb-4 border-b pb-2">æˆ‘çš„åº«å­˜ (Inventory)</h2>
            <div id="inventory-display" class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                <p class="text-gray-500 col-span-4">ç­‰å¾…å¾Œç«¯é€£ç·š...</p>
            </div>
        </div>
    </div>

    <script>
        // API ä¼ºæœå™¨åŸºç¤ URL (å¿…é ˆèˆ‡ Python app.py çš„é‹è¡Œåœ°å€ä¸€è‡´)
        const API_BASE_URL = 'http://127.0.0.1:5000/api';
        const SIMULATE_BUTTON = document.getElementById('simulate-button');
        const STATUS_CONTAINER = document.getElementById('status-message-container');
        const STATUS_MESSAGE = document.getElementById('status-message');
        
        let retryCount = 0;
        const MAX_RETRIES = 5;

        // Helper function for UI updates
        const updateUI = (state, isError = false) => {
            document.getElementById('cash-display').textContent = `$${state.cash.toFixed(2)}`;
            document.getElementById('turn-display').textContent = state.turn;
            
            // æ›´æ–°ç‹€æ…‹è¨Šæ¯æ¨£å¼
            STATUS_CONTAINER.className = 'mt-3 p-2 rounded-md font-bold text-sm';
            if (isError) {
                 STATUS_CONTAINER.classList.add('status-error');
            } else {
                 STATUS_CONTAINER.classList.add('status-success');
            }
            STATUS_MESSAGE.textContent = state.market_message;
            
            // 1. æ›´æ–°å¸‚å ´åƒ¹æ ¼
            const marketGrid = document.getElementById('market-grid');
            marketGrid.innerHTML = ''; // æ¸…ç©ºèˆŠå…§å®¹
            
            Object.keys(state.prices).forEach(pokemon => {
                const price = state.prices[pokemon];
                const card = document.createElement('div');
                card.className = 'p-4 border rounded-xl bg-gray-50 card';
                
                // æª¢æŸ¥æ˜¯å¦æœ‰è¶³å¤ åº«å­˜ä¾†è³£å‡º
                const canSell = state.inventory[pokemon] > 0;
                
                card.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-xl font-bold">${pokemon}</span>
                        <span class="text-2xl font-extrabold text-blue-600">$${price.toFixed(2)}</span>
                    </div>
                    <div class="flex gap-2 mt-3">
                        <input type="number" id="qty-${pokemon}" value="1" min="1" class="w-1/3 p-2 border rounded-md text-center focus:ring-poke-blue focus:border-poke-blue" placeholder="æ•¸é‡">
                        <button onclick="handleTrade('buy', '${pokemon}')" class="w-1/3 bg-green-500 text-white font-semibold py-2 rounded-md hover:bg-green-600 transition disabled:opacity-50">
                            è²·å…¥
                        </button>
                        <button onclick="handleTrade('sell', '${pokemon}')" class="w-1/3 bg-red-500 text-white font-semibold py-2 rounded-md hover:bg-red-600 transition ${canSell ? '' : 'disabled:opacity-50'}" ${canSell ? '' : 'disabled'}>
                            è³£å‡º
                        </button>
                    </div>
                `;
                marketGrid.appendChild(card);
            });

            // 2. æ›´æ–°åº«å­˜
            const inventoryDisplay = document.getElementById('inventory-display');
            inventoryDisplay.innerHTML = '';
            const inventoryKeys = Object.keys(state.inventory);
            if (inventoryKeys.length === 0) {
                 inventoryDisplay.innerHTML = '<p class="text-gray-500 col-span-4">æ‚¨çš„å¯¶å¯å¤¢å€‰åº«æ˜¯ç©ºçš„ï¼</p>';
            } else {
                inventoryKeys.forEach(pokemon => {
                    const count = state.inventory[pokemon];
                    const invItem = document.createElement('div');
                    invItem.className = 'p-3 bg-gray-100 rounded-lg shadow-inner flex flex-col items-center';
                    invItem.innerHTML = `
                        <span class="text-sm font-medium text-gray-600">${pokemon}</span>
                        <span class="text-3xl font-bold text-gray-800">${count} éš»</span>
                    `;
                    inventoryDisplay.appendChild(invItem);
                });
            }
        };

        // æ ¸å¿ƒï¼šèˆ‡ Python å¾Œç«¯æºé€šçš„å‡½æ•¸
        const fetchData = async (endpoint, method = 'GET', data = null) => {
            try {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                };
                if (data) {
                    options.body = JSON.stringify(data);
                }

                SIMULATE_BUTTON.disabled = true;
                
                const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
                const result = await response.json();
                
                // äº¤æ˜“/æ¨¡æ“¬æˆåŠŸæˆ–å¤±æ•—å¾Œï¼ŒæŒ‰éˆ•éƒ½æ‡‰å•Ÿç”¨
                SIMULATE_BUTTON.disabled = false;
                retryCount = 0; // æˆåŠŸé€£ç·šï¼Œé‡ç½®é‡è©¦è¨ˆæ•¸å™¨

                if (response.ok) {
                    // æˆåŠŸç‹€æ…‹
                    updateUI(result.state || result); 
                    return result;
                } else {
                    // è™•ç†å¾Œç«¯è¿”å›çš„éŒ¯èª¤ï¼ˆå¦‚è³‡é‡‘ä¸è¶³ï¼Œç‹€æ…‹ç¢¼ 400ï¼‰
                    // å¾Œç«¯æœƒè¿”å› stateï¼Œæˆ‘å€‘ä¾ç„¶å¯ä»¥æ›´æ–° UI
                    updateUI(result.state, true); 
                    return result;
                }

            } catch (error) {
                console.error('API é€£ç·šéŒ¯èª¤:', error);
                SIMULATE_BUTTON.disabled = true;
                STATUS_CONTAINER.className = 'mt-3 p-2 rounded-md font-bold text-sm status-error';
                STATUS_MESSAGE.textContent = "âš ï¸ é€£ç·šå¤±æ•—ï¼šè«‹ç¢ºä¿æ‚¨çš„ Python ä¼ºæœå™¨ (app.py) æ­£åœ¨é‹è¡Œï¼";
            }
        };

        // è™•ç†è²·è³£äº¤æ˜“
        const handleTrade = (action, pokemon) => {
            const qtyInput = document.getElementById(`qty-${pokemon}`);
            const quantity = parseInt(qtyInput.value, 10);
            
            if (quantity <= 0 || isNaN(quantity)) {
                STATUS_MESSAGE.textContent = "è«‹è¼¸å…¥æœ‰æ•ˆçš„æ•¸é‡ï¼";
                STATUS_CONTAINER.className = 'mt-3 p-2 rounded-md font-bold text-sm status-error';
                return;
            }

            fetchData('/trade', 'POST', { action, pokemon, quantity });
        };

        // è™•ç†ä¸‹ä¸€å›åˆæ¨¡æ“¬æŒ‰éˆ•
        document.getElementById('simulate-button').addEventListener('click', () => {
            fetchData('/simulate', 'POST');
        });
        
        // --- é€£ç·šæª¢æŸ¥èˆ‡é‡è©¦æ©Ÿåˆ¶ ---
        const checkConnection = async () => {
            try {
                // å˜—è©¦é€£ç·šåˆ° /ping ç«¯é»
                STATUS_CONTAINER.className = 'mt-3 p-2 rounded-md font-bold text-sm bg-poke-yellow text-gray-800';
                STATUS_MESSAGE.textContent = "æ­£åœ¨å˜—è©¦é€£ç·šåˆ° Python ä¼ºæœå™¨...";
                
                const response = await fetch(`${API_BASE_URL}/ping`);
                
                if (response.ok) {
                    STATUS_MESSAGE.textContent = "âœ… é€£ç·šæˆåŠŸï¼æ­£åœ¨è®€å–åˆå§‹ç‹€æ…‹...";
                    SIMULATE_BUTTON.disabled = false;
                    fetchData('/state'); // æˆåŠŸå¾Œç²å–éŠæˆ²åˆå§‹ç‹€æ…‹
                    return;
                }
            } catch (error) {
                // å¿½ç•¥éŒ¯èª¤ï¼Œç¨å¾Œé‡è©¦
                console.log(`é€£ç·šå˜—è©¦å¤±æ•— (${retryCount + 1}):`, error.message);
            }

            // é€£ç·šå¤±æ•—ï¼Œé€²è¡Œé‡è©¦
            retryCount++;
            if (retryCount <= MAX_RETRIES) {
                // å¯¦ä½œæŒ‡æ•¸é€€é¿ (Exponential Backoff) å»¶é²
                const delay = Math.pow(2, retryCount) * 500; // 500ms, 1s, 2s, 4s, 8s
                STATUS_CONTAINER.className = 'mt-3 p-2 rounded-md font-bold text-sm status-error';
                STATUS_MESSAGE.textContent = `âŒ é€£ç·šå¤±æ•—ã€‚æ­£åœ¨é‡è©¦ (${retryCount}/${MAX_RETRIES})ï¼Œè«‹æª¢æŸ¥ app.py æ˜¯å¦é‹è¡Œ...`;
                setTimeout(checkConnection, delay);
            } else {
                STATUS_CONTAINER.className = 'mt-3 p-2 rounded-md font-bold text-sm status-error';
                STATUS_MESSAGE.textContent = "âš ï¸ é€£ç·šå¤±æ•—ï¼šå·²é”åˆ°æœ€å¤§é‡è©¦æ¬¡æ•¸ã€‚è«‹ç¢ºèª Python ä¼ºæœå™¨é‹è¡Œæ­£å¸¸ï¼Œä¸¦é‡æ–°æ•´ç†é é¢ã€‚";
                SIMULATE_BUTTON.disabled = true;
            }
        };


        // æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–
        window.onload = () => {
            checkConnection(); // å•Ÿå‹•é€£ç·šæª¢æŸ¥æµç¨‹
        };
    </script>
</body>
</html>